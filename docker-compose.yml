services:
  caddy:
    image: caddy:2.8
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
    depends_on:
      - frontend
      - backend

  frontend:
    build: ./frontend

  backend:
    build: ./backend
    environment:
      DATABASE_URL: ${DATABASE_URL}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      JWT_SECRET: ${JWT_SECRET}
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL}
      COOKIE_SECURE: ${COOKIE_SECURE}
      HOST_DATA_ROOT: /mnt/grishcord
      UPLOADS_DIR: /mnt/grishcord/uploads
      RETENTION_THRESHOLD_PCT: ${RETENTION_THRESHOLD_PCT}
      RETENTION_INTERVAL_MS: ${RETENTION_INTERVAL_MS}
      MAX_IMAGE_BYTES: ${MAX_IMAGE_BYTES}
    volumes:
      - /mnt/grishcord/uploads:/mnt/grishcord/uploads
    depends_on:
      - postgres

  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - /mnt/grishcord/postgres:/var/lib/postgresql/data

  livekit:
    image: livekit/livekit-server:latest
    command: ["--config", "/etc/livekit.yaml"]
    ports:
      - "7881:7881/tcp"
      - "50000-50999:50000-50999/udp"
    volumes:
      - /mnt/grishcord/config/livekit.yaml:/etc/livekit.yaml:ro

  coturn:
    image: coturn/coturn:4.6
    command: ["-c", "/etc/coturn/turnserver.conf"]
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "51000-51999:51000-51999/udp"
    volumes:
      - /mnt/grishcord/config/turnserver.conf:/etc/coturn/turnserver.conf:ro
